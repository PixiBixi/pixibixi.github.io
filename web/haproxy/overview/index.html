<!doctype html><html lang=fr class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Guide complet de HAproxy — configuration, load balancing, ACLs, TLS et exemples pratiques"><meta name=author content="Jérémy DELGADO"><link href="https://wiki.jdelgado.fr/web/haproxy/overview/" rel="canonical"><link href=../memory_limit/ rel=prev><link href=../../mail/exim_manage_dkim/ rel=next><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.18"><title>Reverse proxy: HAproxy - Jérémy Wiki</title><link rel=stylesheet href=../../../assets/stylesheets/main.7e37652d.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel="stylesheet" href="../../../assets/external/fonts.googleapis.com/css.49ea35f2.css"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-NHG8VK60NB"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-NHG8VK60NB",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-NHG8VK60NB",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><link href=../../../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style><script src=../../../assets/javascripts/glightbox.min.js></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#reverse-proxy-haproxy class=md-skip> Aller au contenu </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=En-tête> <a href=../../.. title="Jérémy Wiki" class="md-header__button md-logo" aria-label="Jérémy Wiki" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Jérémy Wiki </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Reverse proxy: HAproxy </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Rechercher placeholder=Rechercher autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Recherche> <button type=reset class="md-search__icon md-icon" title=Effacer aria-label=Effacer tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initialisation de la recherche </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href="https://github.com/PixiBixi/pixibixi.github.io" title="Aller au dépôt" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Onglets data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Sommaire </a> </li> <li class=md-tabs__item> <a href=../../../automation/ansible/ansible/ class=md-tabs__link> Automation </a> </li> <li class=md-tabs__item> <a href=../../../ci-cd/gitlab/cli/ class=md-tabs__link> Ci cd </a> </li> <li class=md-tabs__item> <a href=../../../cloud/aws/cli/ class=md-tabs__link> Cloud </a> </li> <li class=md-tabs__item> <a href=../../../containers/docker/ class=md-tabs__link> Containers </a> </li> <li class=md-tabs__item> <a href=../../../databases/elasticsearch/log_slow_queries/ class=md-tabs__link> Databases </a> </li> <li class=md-tabs__item> <a href=../../../hardware/hdd/wd/fix_hdd/ class=md-tabs__link> Hardware </a> </li> <li class=md-tabs__item> <a href=../../../hypervisor/esxi/upload_iso_cli/ class=md-tabs__link> Hypervisor </a> </li> <li class=md-tabs__item> <a href=../../../kubernetes/argocd/applicationset/ class=md-tabs__link> Kubernetes </a> </li> <li class=md-tabs__item> <a href=../../../linux/advanced/lock_ddos/ class=md-tabs__link> Linux </a> </li> <li class=md-tabs__item> <a href=../../../misc/github_template/ class=md-tabs__link> Misc </a> </li> <li class=md-tabs__item> <a href=../../../monitoring/eztools/ class=md-tabs__link> Monitoring </a> </li> <li class=md-tabs__item> <a href=../../../networking/list_prefix_asn/ class=md-tabs__link> Networking </a> </li> <li class=md-tabs__item> <a href=../../../os/mac/brew/ class=md-tabs__link> Os </a> </li> <li class=md-tabs__item> <a href=../../../selfhost/ajenti/ class=md-tabs__link> Selfhost </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../dns/ class=md-tabs__link> Web </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Jérémy Wiki" class="md-nav__button md-logo" aria-label="Jérémy Wiki" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> Jérémy Wiki </label> <div class=md-nav__source> <a href="https://github.com/PixiBixi/pixibixi.github.io" title="Aller au dépôt" class="md-source" data-md-component="source"> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Sommaire </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../automation/ansible/ansible/ class=md-nav__link> <span class=md-ellipsis> Automation </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../ci-cd/gitlab/cli/ class=md-nav__link> <span class=md-ellipsis> Ci cd </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../cloud/aws/cli/ class=md-nav__link> <span class=md-ellipsis> Cloud </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../containers/docker/ class=md-nav__link> <span class=md-ellipsis> Containers </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../databases/elasticsearch/log_slow_queries/ class=md-nav__link> <span class=md-ellipsis> Databases </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../hardware/hdd/wd/fix_hdd/ class=md-nav__link> <span class=md-ellipsis> Hardware </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../hypervisor/esxi/upload_iso_cli/ class=md-nav__link> <span class=md-ellipsis> Hypervisor </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../kubernetes/argocd/applicationset/ class=md-nav__link> <span class=md-ellipsis> Kubernetes </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../linux/advanced/lock_ddos/ class=md-nav__link> <span class=md-ellipsis> Linux </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../misc/github_template/ class=md-nav__link> <span class=md-ellipsis> Misc </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../monitoring/eztools/ class=md-nav__link> <span class=md-ellipsis> Monitoring </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../networking/list_prefix_asn/ class=md-nav__link> <span class=md-ellipsis> Networking </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../os/mac/brew/ class=md-nav__link> <span class=md-ellipsis> Os </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../selfhost/ajenti/ class=md-nav__link> <span class=md-ellipsis> Selfhost </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_16 checked> <label class=md-nav__link for=__nav_16 id=__nav_16_label tabindex> <span class=md-ellipsis> Web </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_16_label aria-expanded=true> <label class=md-nav__title for=__nav_16> <span class="md-nav__icon md-icon"></span> Web </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../dns/ class=md-nav__link> <span class=md-ellipsis> Installer son NS ainsi que son resolveur DNS via BIND9 </span> </a> </li> <li class=md-nav__item> <a href=../../ftp/ class=md-nav__link> <span class=md-ellipsis> Installer son serveur FTP </span> </a> </li> <li class=md-nav__item> <a href=../../mail/ class=md-nav__link> <span class=md-ellipsis> Postfix/Dovecot/DKIM/Postgrey et plus encore </span> </a> </li> <li class=md-nav__item> <a href=../../troubleshooting/ class=md-nav__link> <span class=md-ellipsis> MOZILLA_PKIX_ERROR_REQUIRED_TLS_FEATURE_MISSING </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_16_5> <label class=md-nav__link for=__nav_16_5 id=__nav_16_5_label tabindex> <span class=md-ellipsis> Benchmark </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_16_5_label aria-expanded=false> <label class=md-nav__title for=__nav_16_5> <span class="md-nav__icon md-icon"></span> Benchmark </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../benchmark/benchmark_random_querystring/ class=md-nav__link> <span class=md-ellipsis> Benchmark avec une random query string </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_16_6 checked> <label class=md-nav__link for=__nav_16_6 id=__nav_16_6_label tabindex> <span class=md-ellipsis> Haproxy </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_16_6_label aria-expanded=true> <label class=md-nav__title for=__nav_16_6> <span class="md-nav__icon md-icon"></span> Haproxy </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../api/ class=md-nav__link> <span class=md-ellipsis> HAproxy : Utiliser son API </span> </a> </li> <li class=md-nav__item> <a href=../cloudflare/ class=md-nav__link> <span class=md-ellipsis> HAproxy : Obtenir les vraies IPs depuis CloudFlare </span> </a> </li> <li class=md-nav__item> <a href=../keep_real_ip/ class=md-nav__link> <span class=md-ellipsis> Conserver l'IP de son visiteur sur un reverse-proxy </span> </a> </li> <li class=md-nav__item> <a href=../maintenance/ class=md-nav__link> <span class=md-ellipsis> HAproxy : Mettre un node en maintenance </span> </a> </li> <li class=md-nav__item> <a href=../memory_limit/ class=md-nav__link> <span class=md-ellipsis> HAproxy : Comportement d'une limite mémoire </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Reverse proxy: HAproxy </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Reverse proxy: HAproxy </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table des matières"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table des matières </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#terminologie class=md-nav__link> <span class=md-ellipsis> Terminologie </span> </a> </li> <li class=md-nav__item> <a href=#configuration-generale class=md-nav__link> <span class=md-ellipsis> Configuration Générale </span> </a> </li> <li class=md-nav__item> <a href=#configuration-haproxy class=md-nav__link> <span class=md-ellipsis> Configuration HAproxy </span> </a> <nav class=md-nav aria-label="Configuration HAproxy"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#global class=md-nav__link> <span class=md-ellipsis> Global </span> </a> </li> <li class=md-nav__item> <a href=#defaults class=md-nav__link> <span class=md-ellipsis> Defaults </span> </a> </li> <li class=md-nav__item> <a href=#frontend class=md-nav__link> <span class=md-ellipsis> Frontend </span> </a> <nav class=md-nav aria-label=Frontend> <ul class=md-nav__list> <li class=md-nav__item> <a href=#definition class=md-nav__link> <span class=md-ellipsis> Définition </span> </a> </li> <li class=md-nav__item> <a href=#exemple-basique class=md-nav__link> <span class=md-ellipsis> Exemple basique </span> </a> </li> <li class=md-nav__item> <a href=#exemple-avance-acl class=md-nav__link> <span class=md-ellipsis> Exemple avancé : ACL </span> </a> </li> <li class=md-nav__item> <a href=#terminaison-tls class=md-nav__link> <span class=md-ellipsis> Terminaison TLS </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#backend class=md-nav__link> <span class=md-ellipsis> Backend </span> </a> <nav class=md-nav aria-label=Backend> <ul class=md-nav__list> <li class=md-nav__item> <a href=#multiples-servers class=md-nav__link> <span class=md-ellipsis> Multiples servers </span> </a> </li> <li class=md-nav__item> <a href=#multiples-avec-persistance class=md-nav__link> <span class=md-ellipsis> Multiples avec persistance </span> </a> </li> <li class=md-nav__item> <a href=#actifpassif class=md-nav__link> <span class=md-ellipsis> Actif/Passif </span> </a> </li> <li class=md-nav__item> <a href=#check-http class=md-nav__link> <span class=md-ellipsis> Check HTTP </span> </a> </li> <li class=md-nav__item> <a href=#check-specifiques class=md-nav__link> <span class=md-ellipsis> Check spécifiques </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#divers class=md-nav__link> <span class=md-ellipsis> Divers </span> </a> <nav class=md-nav aria-label=Divers> <ul class=md-nav__list> <li class=md-nav__item> <a href=#compression-gzip class=md-nav__link> <span class=md-ellipsis> Compression GZIP </span> </a> </li> <li class=md-nav__item> <a href=#desactiver-tous-les-logs class=md-nav__link> <span class=md-ellipsis> Désactiver tous les logs </span> </a> </li> <li class=md-nav__item> <a href=#backend-cache class=md-nav__link> <span class=md-ellipsis> Backend cache </span> </a> </li> <li class=md-nav__item> <a href=#http-to-https class=md-nav__link> <span class=md-ellipsis> HTTP to HTTPS </span> </a> </li> <li class=md-nav__item> <a href=#rediriger-des-urls-specifiques-vers-dautres class=md-nav__link> <span class=md-ellipsis> Rediriger des URLs spécifiques vers d'autres </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_16_7> <label class=md-nav__link for=__nav_16_7 id=__nav_16_7_label tabindex> <span class=md-ellipsis> Mail </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_16_7_label aria-expanded=false> <label class=md-nav__title for=__nav_16_7> <span class="md-nav__icon md-icon"></span> Mail </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../mail/exim_manage_dkim/ class=md-nav__link> <span class=md-ellipsis> Configurer DKIM avec Exim </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_16_8> <label class=md-nav__link for=__nav_16_8 id=__nav_16_8_label tabindex> <span class=md-ellipsis> Nginx </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_16_8_label aria-expanded=false> <label class=md-nav__title for=__nav_16_8> <span class="md-nav__icon md-icon"></span> Nginx </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../nginx/custom_server_header/ class=md-nav__link> <span class=md-ellipsis> Être encore plus safe en customisant son header Server NGINX </span> </a> </li> <li class=md-nav__item> <a href=../../nginx/fetch_good_ips/ class=md-nav__link> <span class=md-ellipsis> Obtenir les bonnes IP sur apache derrière un reverse proxy </span> </a> </li> <li class=md-nav__item> <a href=../../nginx/installation/ class=md-nav__link> <span class=md-ellipsis> Installer son Serveur Web : NGINX, PHP-FPM et MariaDB </span> </a> </li> <li class=md-nav__item> <a href=../../nginx/ipv6_nginx/ class=md-nav__link> <span class=md-ellipsis> Configurer nginx pour utiliser IPv6 </span> </a> </li> <li class=md-nav__item> <a href=../../nginx/nginx_ssl/ class=md-nav__link> <span class=md-ellipsis> Forcer le SSL sous NGINX </span> </a> </li> <li class=md-nav__item> <a href=../../nginx/php_custom_version/ class=md-nav__link> <span class=md-ellipsis> Installer une version custom de PHP </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_16_9> <label class=md-nav__link for=__nav_16_9 id=__nav_16_9_label tabindex> <span class=md-ellipsis> Ruby </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_16_9_label aria-expanded=false> <label class=md-nav__title for=__nav_16_9> <span class="md-nav__icon md-icon"></span> Ruby </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ruby/install/ class=md-nav__link> <span class=md-ellipsis> Installer Ruby </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_16_10> <label class=md-nav__link for=__nav_16_10 id=__nav_16_10_label tabindex> <span class=md-ellipsis> Varnish </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_16_10_label aria-expanded=false> <label class=md-nav__title for=__nav_16_10> <span class="md-nav__icon md-icon"></span> Varnish </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../varnish/config/ class=md-nav__link> <span class=md-ellipsis> Config varnish </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_16_11> <label class=md-nav__link for=__nav_16_11 id=__nav_16_11_label tabindex> <span class=md-ellipsis> Wordpress </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_16_11_label aria-expanded=false> <label class=md-nav__title for=__nav_16_11> <span class="md-nav__icon md-icon"></span> Wordpress </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../wordpress/migrate_wordpress_sql/ class=md-nav__link> <span class=md-ellipsis> Requêtes SQL pour migrer son WordPress </span> </a> </li> <li class=md-nav__item> <a href=../../wordpress/tips_sql/ class=md-nav__link> <span class=md-ellipsis> Requêtes SQL afin d'optimiser son site </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <nav class=md-tags> <span class=md-tag>HAProxy</span> <span class=md-tag>Load Balancing</span> <span class=md-tag>Web</span> <span class=md-tag>Web Hosting</span> </nav> <h1 id=reverse-proxy-haproxy>Reverse proxy: HAproxy</h1> <div class="admonition warning"> <p class=admonition-title>Version HAproxy</p> <p>Les directives et options évoluent entre les versions majeures. Vérifiez toujours la version installée (<code>haproxy -v</code>) et consultez la <a href="https://docs.haproxy.org/3.3/management.html">documentation officielle</a> correspondante. La version actuelle stable est la <strong>3.3</strong>.</p> </div> <p>HAproxy est un reverse proxy optimisé pour les fortes charges créé en 2000 par Willy Tarreau, un contributeur kernel. Ce dernier propose toutes les fonctionnalités d'un reverse proxy classique :</p> <ul> <li>L4/L7 Balancing</li> <li>Terminaison TLS</li> </ul> <p>Il est également utilisé par de nombreux sites populaires :</p> <ul> <li>Twitter</li> <li>Github</li> <li>Reddit</li> <li>Airbnb...</li> </ul> <p>Comme tout package, il est simplement installable via un package manager tel que <em>apt</em> ou autre.</p> <h2 id=terminologie>Terminologie</h2> <p>HAproxy utilise des termes assez classiques. Cependant, nous avons quelques terminologies spécifiques à HAproxy</p> <ul> <li><strong>bind</strong> : attacher en Anglais, permet de dire sur quelle IP et quel port HAproxy va écouter. Par exemple, 192.168.1.1 sur le port 80</li> <li><strong>frontend</strong> : c'est un bloc de configuration qui permet de définir toutes les règles qui s'appliqueront (domaines écoutés, limitations, etc). Un frontend peut s'appliquer à un ou plusieurs bind.</li> <li><strong>backend</strong> : c'est un autre bloc de configuration, que l'on place derrière un frontend. Si le frontend gère ce qui est publique (à '"l'"avant'" du serveur), le backend gère '"l'arrière'". C'est là que vous définirez les serveurs web vers lesquels envoyer les requêtes, les différents checks appliqués...</li> <li><strong>ACL</strong> : une '"Access Control List'" permet de définir des conditions dans un bloc, par exemple '"si le domaine contient site1, alors faire cela, si la requête est en https, alors faire ceci'". Il s'agit ici de la grande spécificité de HAproxy face à ses concurrents.</li> </ul> <h2 id=configuration-generale>Configuration Générale</h2> <p>Par défaut, toute la configuration de HAproxy se fait dans un unique fichier : <em>haproxy.cfg</em>. Cependant, lors d'une configuration un peu poussée, il devient très vite illisible.</p> <p>Heureusement, il est facile de split la configuration. Dans le fichier <em>/etc/default/haproxy</em>, il vous suffit de faire la modification suivante:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=c1># Change the config file location if needed</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=c1>#CONFIG=&quot;/etc/haproxy/haproxy.cfg&quot;</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=nv>CONFIG</span><span class=o>=</span><span class=s2>&quot;/etc/haproxy&quot;</span>
</code></pre></div> <p>La variable CONFIG est utilisée pour le paramètre <code>-F $CONFIG</code> de l'unit systemd. Voici ce que nous dit la <a href="https://docs.haproxy.org/3.3/management.html">documentation haproxy</a> :</p> <details class=note> <summary>HAproxy : Official Documentation</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=w>  </span>-f<span class=w> </span>&lt;cfgfile<span class=p>|</span>cfgdir&gt;<span class=w> </span>:<span class=w> </span>adds<span class=w> </span>&lt;cfgfile&gt;<span class=w> </span>to<span class=w> </span>the<span class=w> </span>list<span class=w> </span>of<span class=w> </span>configuration<span class=w> </span>files<span class=w> </span>to<span class=w> </span>be
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>    </span>loaded.<span class=w> </span>If<span class=w> </span>&lt;cfgdir&gt;<span class=w> </span>is<span class=w> </span>a<span class=w> </span>directory,<span class=w> </span>all<span class=w> </span>the<span class=w> </span>files<span class=w> </span><span class=o>(</span>and<span class=w> </span>only<span class=w> </span>files<span class=o>)</span><span class=w> </span>it
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>    </span>contains<span class=w> </span>are<span class=w> </span>added<span class=w> </span><span class=k>in</span><span class=w> </span>lexical<span class=w> </span>order<span class=w> </span><span class=o>(</span>using<span class=w> </span><span class=nv>LC_COLLATE</span><span class=o>=</span>C<span class=o>)</span><span class=w> </span>to<span class=w> </span>the<span class=w> </span>list<span class=w> </span>of
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>    </span>configuration<span class=w> </span>files<span class=w> </span>to<span class=w> </span>be<span class=w> </span>loaded<span class=w> </span><span class=p>;</span><span class=w> </span>only<span class=w> </span>files<span class=w> </span>with<span class=w> </span><span class=s2>&quot;.cfg&quot;</span><span class=w> </span>extension<span class=w> </span>are
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>    </span>added,<span class=w> </span>only<span class=w> </span>non<span class=w> </span>hidden<span class=w> </span>files<span class=w> </span><span class=o>(</span>not<span class=w> </span>prefixed<span class=w> </span>with<span class=w> </span><span class=s2>&quot;.&quot;</span><span class=o>)</span><span class=w> </span>are<span class=w> </span>added.
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>    </span>Configuration<span class=w> </span>files<span class=w> </span>are<span class=w> </span>loaded<span class=w> </span>and<span class=w> </span>processed<span class=w> </span><span class=k>in</span><span class=w> </span>their<span class=w> </span>declaration<span class=w> </span>order.
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>    </span>This<span class=w> </span>option<span class=w> </span>may<span class=w> </span>be<span class=w> </span>specified<span class=w> </span>multiple<span class=w> </span><span class=nb>times</span><span class=w> </span>to<span class=w> </span>load<span class=w> </span>multiple<span class=w> </span>files.<span class=w> </span>See
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>    </span>also<span class=w> </span><span class=s2>&quot;--&quot;</span>.<span class=w> </span>The<span class=w> </span>difference<span class=w> </span>between<span class=w> </span><span class=s2>&quot;--&quot;</span><span class=w> </span>and<span class=w> </span><span class=s2>&quot;-f&quot;</span><span class=w> </span>is<span class=w> </span>that<span class=w> </span>one<span class=w> </span><span class=s2>&quot;-f&quot;</span><span class=w> </span>must<span class=w> </span>be
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>    </span>placed<span class=w> </span>before<span class=w> </span>each<span class=w> </span>file<span class=w> </span>name,<span class=w> </span><span class=k>while</span><span class=w> </span>a<span class=w> </span>single<span class=w> </span><span class=s2>&quot;--&quot;</span><span class=w> </span>is<span class=w> </span>needed<span class=w> </span>before<span class=w> </span>all<span class=w> </span>file
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=w>    </span>names.<span class=w> </span>Both<span class=w> </span>options<span class=w> </span>can<span class=w> </span>be<span class=w> </span>used<span class=w> </span>together,<span class=w> </span>the<span class=w> </span><span class=nb>command</span><span class=w> </span>line<span class=w> </span>ordering<span class=w> </span>still
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=w>    </span>applies.<span class=w> </span>When<span class=w> </span>more<span class=w> </span>than<span class=w> </span>one<span class=w> </span>file<span class=w> </span>is<span class=w> </span>specified,<span class=w> </span>each<span class=w> </span>file<span class=w> </span>must<span class=w> </span>start<span class=w> </span>on<span class=w> </span>a
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=w>    </span>section<span class=w> </span>boundary,<span class=w> </span>so<span class=w> </span>the<span class=w> </span>first<span class=w> </span>keyword<span class=w> </span>of<span class=w> </span>each<span class=w> </span>file<span class=w> </span>must<span class=w> </span>be<span class=w> </span>one<span class=w> </span>of
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=w>    </span><span class=s2>&quot;global&quot;</span>,<span class=w> </span><span class=s2>&quot;defaults&quot;</span>,<span class=w> </span><span class=s2>&quot;peers&quot;</span>,<span class=w> </span><span class=s2>&quot;listen&quot;</span>,<span class=w> </span><span class=s2>&quot;frontend&quot;</span>,<span class=w> </span><span class=s2>&quot;backend&quot;</span>,<span class=w> </span>and<span class=w> </span>so<span class=w> </span>on.
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=w>    </span>A<span class=w> </span>file<span class=w> </span>cannot<span class=w> </span>contain<span class=w> </span>just<span class=w> </span>a<span class=w> </span>server<span class=w> </span>list<span class=w> </span><span class=k>for</span><span class=w> </span>example.
</code></pre></div> </details> <p>Tous les fichiers se terminant par .cfg seront chargés par HAproxy par ordre alphabétique.</p> <p>Voici la configuration lancée par défaut via l'unit systemd :</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=nv>ExecStartPre</span><span class=o>=</span>/usr/sbin/haproxy<span class=w> </span>-f<span class=w> </span><span class=si>${</span><span class=nv>CONFIG</span><span class=si>}</span><span class=w> </span>-c<span class=w> </span>-q
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=nv>ExecStart</span><span class=o>=</span>/usr/sbin/haproxy-systemd-wrapper<span class=w> </span>-f<span class=w> </span><span class=si>${</span><span class=nv>CONFIG</span><span class=si>}</span><span class=w> </span>-p<span class=w> </span>/run/haproxy.pid<span class=w> </span><span class=nv>$EXTRAOPTS</span>
</code></pre></div> <h2 id=configuration-haproxy>Configuration HAproxy</h2> <p>Pour rappel, avec une configuration splitted de HAproxy, il va lire les fichiers par ordre alphabétique, il est donc important d'avoir les sections global et defaults avant les frontend et backend. Pour être sûr de l'ordre, vous pouvez prefix vos fichiers avec des numéros.</p> <h3 id=global>Global</h3> <p>Comme son nom l'indique, toute la partie globale concerne les directives propres au fonctionnement interne de HAproxy. Voici un exemple simple, que nous allons retrouver dans un grand nombre de configuration HAproxy</p> <details class=example> <summary>HAproxy: Global section</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>global
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>    maxconn 50000
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    log /dev/log local0
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    user haproxy
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>    group haproxy
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>    stats socket /run/haproxy/admin.sock user haproxy group haproxy mode 660 level admin
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>    nbthread 4
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>    cpu-map auto:1-4 0-3
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>    daemon
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
</code></pre></div> </details> <ul> <li><code>maxconn</code> nous permet de limiter le nombre de connexions acceptées par HAproxy pour prémunir un manque de mémoire. Attention à ne pas faire un sizing trop juste, ce qui nous induirait un drop de connexions légitimes.</li> <li><code>log</code> nous permet de spécifier où sont renvoyés les logs. Dans notre cas, nous les loggerons dans rsyslog (/dev/log) en tant que local0. rsyslog s'occupera de traiter les logs. (par défaut, écriture dans /var/log/syslog).</li> <li><code>user/group</code> indique à haproxy qu'il ne faut pas lancer les fork en tant que root, mais en tant qu'haproxy dans notre cas.</li> <li><code>stats socket</code> nous permet de définir un socket afin d'y extraire les stats ou autre. Il est également possible d'écrire la configuration de HAproxy via ce moyen. Attention à donc bien restreindre les privilèges. <!-- markdownlint-disable-next-line --><ul> <li>SleepLessBeastie a écrit <a href="https://sleeplessbeastie.eu/2020/01/29/how-to-use-haproxy-stats-socket/">un excellent article</a> sur la définition des privilèges et comment interagir avec l'API.</li> </ul> </li> <li><code>nbthread</code> permet à HAproxy de scaler sur plusieurs threads. Utiliser <code>auto</code> pour détecter automatiquement le nombre de threads disponibles, ou spécifier un entier. <!-- markdownlint-disable-next-line --><ul> <li><code>nbproc</code> (multi-processus) est <strong>déprécié depuis HAProxy 2.5</strong> et <strong>supprimé en 2.9</strong>. Ne plus utiliser cette directive.</li> </ul> </li> <li><code>cpu-map</code> permet de binder chaque thread sur un core CPU dédié. La syntaxe avec <code>nbthread</code> : <code>cpu-map auto:&lt;thread-range&gt; &lt;cpu-range&gt;</code></li> <li><code>daemon</code> permet de lancer HAproxy en tant que daemon. Indépendant de <code>nbthread</code> — les deux directives n'ont aucune dépendance l'une envers l'autre.</li> <li><code>ssl-default-bind-ciphers</code> configure les ciphers <strong>TLS 1.2</strong>. <code>ssl-default-bind-ciphersuites</code> configure les ciphers <strong>TLS 1.3</strong> (directive distincte, obligatoire pour couvrir les deux versions). <code>ssl-default-bind-options</code> configure les versions autorisées et options associées. <!-- markdownlint-disable-next-line --><ul> <li>La fondation Mozilla propose un <a href="https://ssl-config.mozilla.org/#server=haproxy&amp;version=3.3&amp;config=intermediate">configurateur</a> pour HAProxy 3.x. Le profil Intermediate est adapté pour une utilisation en production.</li> </ul> </li> </ul> <h3 id=defaults>Defaults</h3> <p>Votre configuration est évolution, c'est pour cela que la catégorie <code>defaults</code> existe. Les paramètres seront appliqués pour la section frontend mais également pour les backends. Vous pouvez overwrite vos paramètres pour un frontend/backend spécifique par la suite</p> <!-- markdownlint-disable MD046 --> <details class=example> <summary>HAproxy: Default section</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>defaults
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>    mode http
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>    log global
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>    option httplog
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>    option dontlognull
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>    timeout connect 10s
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>    timeout client 30s
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>    timeout server 30s
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>    timeout http-request 5s
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>    timeout http-keep-alive 125s
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>
<a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a>    timeout client-fin 30s
<a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>    timeout tunnel 1h
<a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>
<a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>    http-reuse safe
</code></pre></div> </details> <!-- markdownlint-enable MD046 --> <ul> <li><code>mode http</code> indique à HAproxy de fonctionner en tant que balancer HTTP et non simplement TCP. Légèrement plus lent que le TCP mais nous permet une granularité de configuration bien supérieure</li> <li>N'oubliez pas que HAproxy est également un load-balancer L4. Il est donc possible de balancer tout type de traffic (mysql, rabbitmq, mongodb...)</li> <li><code>log global</code> indique à chaque frontend suivant d'utiliser le paramètre log contenu dans la section global. Cela nous évite de devoir le redéfinir pour chaque frontend.</li> <li><code>option httplog</code> indique à HAproxy de fournir un syslog un format de log plus détaillé. Il existe également l'attribut <code>tcplog</code> si vous utilisez le load-balancer en tant que balancer L4 (TCP)</li> <li><code>option dontlognull</code> permet de ne pas logger les sessions n'ayant donné aucun échange de donnée (requête ou réponse) <!-- markdownlint-disable-next-line --><ul> <li>Il peut être intéressant de les log en pour avoir des logs bien plus détaillés. Peut-être utile en cas de saturation socket (DOS ou autre). <!-- markdownlint-disable-next-line --></li> <li>Certaines méthodes (tel qu'un monitoring ou autre) peuvent également générer certaines de ces requêtes. Il peut être intéressant d'activer cette option dans ce cas</li> </ul> </li> <li><code>timeout connect...</code> spécifie les différents timeout (connect, server)... <!-- markdownlint-disable-next-line --><ul> <li>Il peut être intéressant de spécifier différentes valeurs de timeout afin de faciliter le debug</li> </ul> </li> </ul> <!-- markdownlint-disable MD013 --> <ul> <li><code>http-reuse safe</code> est l'option par défaut. Nous nous assurons via le paramètre <code>safe</code> que le serveur ferme la connexion lorsque quand la requête a été envoyée</li> </ul> <h3 id=frontend>Frontend</h3> <h4 id=definition>Définition</h4> <p>Les frontends sont utilisés pour définir comment les demandes doivent être transmises aux backends. Ils se composent des éléments suivants :</p> <ul> <li>Adresses IP/Ports</li> <li>ACLs</li> <li>Règles quant à l'utilisation spécifiques de backends</li> </ul> <h4 id=exemple-basique>Exemple basique</h4> <p>L'exemple suivant est l'exemple le plus simple que nous pouvons faire sur HAproxy. HAproxy va écouter sur le port 80 et tout renvoyer le traffic vers le backend <em>servers</em>. Nous n'utilisons aucune ACL ici.</p> <details class=example> <summary>HAproxy : Simple frontend</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=w>    </span><span class=n>frontend</span><span class=w> </span><span class=n>http</span><span class=o>-</span><span class=n>in</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>        </span><span class=n>bind</span><span class=w> </span><span class=o>*</span><span class=err>:</span><span class=m>80</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>        </span><span class=n>default_backend</span><span class=w> </span><span class=n>servers</span>
</code></pre></div> </details> <h4 id=exemple-avance-acl>Exemple avancé : ACL</h4> <p>Un exemple avancé est l'utilisation d'une ACL. Il existe beaucoup de types d'ACL, que ce soir sur l'URI, les paramètres... Nous allons voir un exemple simple avec l'utilisation d'une ACL sur le nom de domaine.</p> <!-- markdownlint-disable MD046 MD037 --> <details class=example> <summary>HAproxy : Simple frontend w/ ACL</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=n>frontend</span><span class=w> </span><span class=n>http</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>   </span><span class=n>bind</span><span class=w> </span><span class=o>*</span><span class=err>:</span><span class=m>80</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>   </span><span class=c># On définit des ACL qui associe un Host: HTTP à un backend</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>   </span><span class=n>acl</span><span class=w> </span><span class=n>wiki</span><span class=w> </span><span class=n>hdr</span><span class=p>(</span><span class=n>host</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=n>i</span><span class=w> </span><span class=n>wiki</span><span class=o>.</span><span class=n>jdelgado</span><span class=o>.</span><span class=n>fr</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=w>   </span><span class=n>acl</span><span class=w> </span><span class=n>site</span><span class=w> </span><span class=n>hdr</span><span class=p>(</span><span class=n>host</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=n>i</span><span class=w> </span><span class=n>jdelgado</span><span class=o>.</span><span class=n>fr</span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>   </span><span class=n>use_backend</span><span class=w> </span><span class=n>wiki</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>wiki</span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>   </span><span class=n>use_backend</span><span class=w> </span><span class=n>site</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=n>site</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=w>   </span><span class=n>default_backend</span><span class=w> </span><span class=n>undefined</span>
</code></pre></div> </details> <!-- markdownlint-enable MD046 --> <p>Nous définissons ici un backend par défaut. Il est possible de ne pas en définir et HAproxy renverra une erreur 421 de lui même.</p> <h4 id=terminaison-tls>Terminaison TLS</h4> <p>HAproxy peut terminer le TLS directement sur le <code>bind</code>. La méthode recommandée est le répertoire de certificats : HAproxy charge automatiquement tous les fichiers <code>.pem</code> qu'il contient et sélectionne le bon certificat via SNI.</p> <p>Chaque fichier <code>.pem</code> doit contenir le certificat (fullchain) <strong>et</strong> la clé privée concaténés :</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>cat<span class=w> </span>/etc/letsencrypt/live/wiki.jdelgado.fr/fullchain.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=w>    </span>/etc/letsencrypt/live/wiki.jdelgado.fr/privkey.pem<span class=w> </span><span class=se>\</span>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>    </span>&gt;<span class=w> </span>/etc/haproxy/certs/wiki.jdelgado.fr.pem
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>chmod<span class=w> </span><span class=m>600</span><span class=w> </span>/etc/haproxy/certs/wiki.jdelgado.fr.pem
</code></pre></div> <!-- markdownlint-disable MD046 MD037 --> <details class=example> <summary>HAproxy : Frontend avec terminaison TLS</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>frontend https
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>    bind *:80
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>    bind *:443 ssl crt /etc/haproxy/certs/ alpn h2,http/1.1
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>    # Redirection HTTP → HTTPS
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>    http-request redirect scheme https code 301 unless { ssl_fc }
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>    acl wiki hdr(host) -i wiki.jdelgado.fr
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>    acl site hdr(host) -i jdelgado.fr
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>    use_backend wiki if wiki
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>    use_backend site if site
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>    default_backend undefined
</code></pre></div> </details> <!-- markdownlint-enable MD046 --> <p>La négociation TLS étant terminée avant l'évaluation des ACLs, <code>hdr(host)</code> suffit. Pas besoin de filtrer sur <code>ssl_fc_sni</code>. L'option <code>alpn h2,http/1.1</code> active HTTP/2 via négociation ALPN.</p> <h3 id=backend>Backend</h3> <p>Les backends sont la force de HAproxy, entièrement modulables, nous pouvons réellement faire ce que l'on souhaite avec ceux-ci. Prenant cet exemple simple :</p> <h4 id=multiples-servers>Multiples servers</h4> <details class=example> <summary>HAproxy : Multiple backends</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=w>    </span><span class=n>backend</span><span class=w> </span><span class=n>web_servers</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=n>server1</span><span class=w> </span><span class=m>10</span><span class=o>.</span><span class=m>0</span><span class=o>.</span><span class=m>1</span><span class=o>.</span><span class=m>3</span><span class=err>:</span><span class=m>80</span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=n>server2</span><span class=w> </span><span class=m>10</span><span class=o>.</span><span class=m>0</span><span class=o>.</span><span class=m>1</span><span class=o>.</span><span class=m>4</span><span class=err>:</span><span class=m>80</span>
</code></pre></div> </details> <p>Nous avons ici 2 server dénommé respectivement server1 et server2 sur les IPs 10.0.1.3 et 10.0.1.4 écoutant sur le port 80. Nous n'avons ici aucun paramètre spécifique sur un éventuel check de disponiblité ou autre, chacun recevra 50% du traffic</p> <h4 id=multiples-avec-persistance>Multiples avec persistance</h4> <p>Nous pouvons demander à HAproxy de déposer un cookie sur le client pour effectuer un équilibrage de charge :</p> <details class=example> <summary>HAproxy : Multiple backends with persistance</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=w>    </span><span class=n>backend</span><span class=w> </span><span class=n>web_servers</span>
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=w>        </span><span class=n>balance</span><span class=w> </span><span class=n>roundrobin</span>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=w>        </span><span class=n>cookie</span><span class=w> </span><span class=n>srvid</span><span class=w> </span><span class=n>insert</span><span class=w> </span><span class=n>indirect</span><span class=w> </span><span class=n>nocache</span>
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=w>        </span><span class=n>option</span><span class=w> </span><span class=n>httpchk</span><span class=w> </span><span class=n>HEAD</span><span class=w> </span><span class=o>/</span>
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=n>server1</span><span class=w> </span><span class=m>10</span><span class=o>.</span><span class=m>0</span><span class=o>.</span><span class=m>1</span><span class=o>.</span><span class=m>3</span><span class=err>:</span><span class=m>80</span><span class=w> </span><span class=n>cookie</span><span class=w> </span><span class=n>server1</span>
<a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=n>server2</span><span class=w> </span><span class=m>10</span><span class=o>.</span><span class=m>0</span><span class=o>.</span><span class=m>1</span><span class=o>.</span><span class=m>4</span><span class=err>:</span><span class=m>80</span><span class=w> </span><span class=n>cookie</span><span class=w> </span><span class=n>server2</span>
</code></pre></div> </details> <p>Le client recevra un cookie dénommé srvid qui sera utilisé par haproxy pour balancer le traffic en round-robin.</p> <h4 id=actifpassif>Actif/Passif</h4> <p>Il est possible d'avoir plusieurs servers sur le même backend mais n'en utiliser qu'un '"primaire'". Il suffit d'ajouter le mot clef <code>backup</code> au serveur secondaire :</p> <details class=example> <summary>HAproxy : Multiple backends with backup</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=w>    </span><span class=n>backend</span><span class=w> </span><span class=n>web_servers</span>
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=n>server1</span><span class=w> </span><span class=m>10</span><span class=o>.</span><span class=m>0</span><span class=o>.</span><span class=m>1</span><span class=o>.</span><span class=m>3</span><span class=err>:</span><span class=m>80</span>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=n>server2</span><span class=w> </span><span class=m>10</span><span class=o>.</span><span class=m>0</span><span class=o>.</span><span class=m>1</span><span class=o>.</span><span class=m>4</span><span class=err>:</span><span class=m>80</span><span class=w> </span><span class=n>backup</span>
</code></pre></div> </details> <h4 id=check-http>Check HTTP</h4> <details class=example> <summary>HAproxy : Multiple backends with HTTP check</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=w>    </span><span class=n>backend</span><span class=w> </span><span class=n>web_servers</span>
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=w>        </span><span class=n>option</span><span class=w> </span><span class=n>httpchk</span><span class=w> </span><span class=n>HEAD</span><span class=w> </span><span class=o>/</span>
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=n>server1</span><span class=w> </span><span class=m>10</span><span class=o>.</span><span class=m>0</span><span class=o>.</span><span class=m>1</span><span class=o>.</span><span class=m>3</span><span class=err>:</span><span class=m>80</span>
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=n>server2</span><span class=w> </span><span class=m>10</span><span class=o>.</span><span class=m>0</span><span class=o>.</span><span class=m>1</span><span class=o>.</span><span class=m>4</span><span class=err>:</span><span class=m>80</span>
</code></pre></div> </details> <p>Il s'agit ici du même backend qu'au préalable mais avec une différence importante, la présence de <code>httpchk</code>. Nous avons ici la présence d'un véritable check L7 au lieu d'un check TCP L4. HAproxy sera ici capable de distinguer un serveur HTTP down au niveau L7 (tel qu'une erreur 50x). Il est possible d'affiner le check, nous avons ici une simple requête HEAD sur /</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=w>     </span><span class=n>option</span><span class=w> </span><span class=n>httpchk</span><span class=w> </span><span class=n>GET</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>HTTP</span><span class=o>/</span><span class=m>1</span><span class=o>.</span><span class=m>1</span><span class=err>\</span><span class=n>r</span><span class=err>\</span><span class=n>nHost</span><span class=err>:\</span><span class=w> </span><span class=n>www</span><span class=o>.</span><span class=n>jdelgado</span><span class=o>.</span><span class=n>fr</span><span class=err>\</span><span class=n>r</span><span class=err>\</span><span class=n>nUser</span><span class=o>-</span><span class=n>Agent</span><span class=err>:\</span><span class=w> </span><span class=n>haproxy_check</span>
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=w>     </span><span class=n>http</span><span class=o>-</span><span class=n>check</span><span class=w> </span><span class=n>expect</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=m>200</span>
</code></pre></div> <!-- markdownlint-disable MD034 --> <!-- markdownlint-disable MD013 --> <p>Ce test est légèrement plus détaillé. Nous spécifions ici un Host à utilisé (www.jdelgado.fr) ainsi que l'user-agent. Nous spécifions également que nous attendons un retour 200 (OK).</p> <h4 id=check-specifiques>Check spécifiques</h4> <p>HAproxy intègre différents checks pour différents protocoles. Voici les checks disponibles</p> <ul> <li>option mysql-check</li> <li>option pgsql-check</li> <li>option redis-check</li> <li>option smtpchk</li> </ul> <h2 id=divers>Divers</h2> <h3 id=compression-gzip>Compression GZIP</h3> <p>On peut activer la compression gzip directement au niveau de HAproxy. Génial si le backend ne le gère pas :</p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=n>compression</span><span class=w> </span><span class=n>algo</span><span class=w> </span><span class=n>gzip</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=n>compression</span><span class=w> </span><span class=n>type</span><span class=w> </span><span class=n>text</span><span class=o>/</span><span class=n>html</span><span class=w> </span><span class=n>text</span><span class=o>/</span><span class=n>plain</span><span class=w> </span><span class=n>text</span><span class=o>/</span><span class=n>xml</span><span class=w> </span><span class=n>text</span><span class=o>/</span><span class=n>css</span><span class=w> </span><span class=n>text</span><span class=o>/</span><span class=n>javascript</span><span class=w> </span><span class=n>application</span><span class=o>/</span><span class=n>javascript</span><span class=w> </span><span class=n>application</span><span class=o>/</span><span class=n>json</span><span class=w> </span><span class=n>text</span><span class=o>/</span><span class=n>json</span>
</code></pre></div> <h3 id=desactiver-tous-les-logs>Désactiver tous les logs</h3> <p>Par défaut, HAproxy log des évènements. Il ne suffit pas d'enlever l'option tcplog ou autre.</p> <p>Dans la section defaults, il faut ajouter ceci :</p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=n>option</span><span class=w> </span><span class=n>dontlog</span><span class=o>-</span><span class=n>normal</span>
</code></pre></div> <h3 id=backend-cache>Backend cache</h3> <p>Si vous utilisez un cache en backend (tel que varnish), il est alors très intéressant de spécifier le type de balance. <strong>balance uri whole</strong> indique à haproxy de toujours envoyer le traffic pour une URI spécifique vers le même backend. Ainsi, nous maximisons le hitrate.</p> <details class=example> <summary>HAproxy : Backend Varnish</summary> </details> <!-- markdownlint-disable MD046 --> <div class=highlight><pre><span></span><code>```vcl
backend varnish
    timeout     check 3000
    balance uri whole
    hash-type consistent

    server      varnish01  varnish01.vlan:82  check
    server      varnish02  varnish02.vlan:82  check
```
</code></pre></div> <!-- markdownlint-enable MD046 --> <h3 id=http-to-https>HTTP to HTTPS</h3> <p>Il est facile de rediriger l'intégralité du traffic HTTP vers HTTPS avec HAproxy. Ajoutez simplement la ligne suivante dans votre frontend :</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=w>    </span><span class=n>http</span><span class=o>-</span><span class=n>request</span><span class=w> </span><span class=n>redirect</span><span class=w> </span><span class=n>scheme</span><span class=w> </span><span class=n>https</span><span class=w> </span><span class=n>unless</span><span class=w> </span><span class=o>{</span><span class=w> </span><span class=n>ssl_fc</span><span class=w> </span><span class=o>}</span>
</code></pre></div> <p>Cependant, nous avons une 302 (redirection non permanente) via cette méthode. Pour un usage durable dans le temps, nous préférons à cela une 301 :</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=w>    </span><span class=n>http</span><span class=o>-</span><span class=n>request</span><span class=w> </span><span class=n>redirect</span><span class=w> </span><span class=n>scheme</span><span class=w> </span><span class=n>https</span><span class=w> </span><span class=n>code</span><span class=w> </span><span class=m>301</span><span class=w> </span><span class=n>unless</span><span class=w> </span><span class=o>{</span><span class=w> </span><span class=n>ssl_fc</span><span class=w> </span><span class=o>}</span>
</code></pre></div> <h3 id=rediriger-des-urls-specifiques-vers-dautres>Rediriger des URLs spécifiques vers d'autres</h3> <p>Si pour quelconques raison vous voulez retournez des URLs custom selon des URI précises, la manière la plus facile :</p> <!-- markdownlint-disable MD013 --> <details class=example> <summary>HAproxy : Using map</summary> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=w>    </span><span class=n>acl</span><span class=w>     </span><span class=n>acl</span><span class=w>           </span><span class=n>hdr_beg</span><span class=p>(</span><span class=n>host</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=n>i</span><span class=w> </span><span class=n>monsite</span><span class=o>.</span><span class=n>fr</span>
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=w>    </span><span class=n>acl</span><span class=w>     </span><span class=n>acl</span><span class=w>           </span><span class=n>hdr_beg</span><span class=p>(</span><span class=n>host</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=n>i</span><span class=w> </span><span class=n>www</span><span class=o>.</span><span class=n>monsite</span><span class=o>.</span><span class=n>fr</span>
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=w>    </span><span class=n>http</span><span class=o>-</span><span class=n>request</span><span class=w> </span><span class=n>redirect</span><span class=w> </span><span class=n>location</span><span class=w> </span><span class=o>%</span><span class=err>[</span><span class=n>capture</span><span class=o>.</span><span class=n>req</span><span class=o>.</span><span class=n>uri</span><span class=o>,</span><span class=n>map</span><span class=p>(</span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>haproxy</span><span class=o>/</span><span class=n>redirect</span><span class=o>.</span><span class=n>map</span><span class=p>)</span><span class=err>]</span><span class=w> </span><span class=n>code</span><span class=w> </span><span class=m>301</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=o>{</span><span class=w> </span><span class=n>capture</span><span class=o>.</span><span class=n>req</span><span class=o>.</span><span class=n>uri</span><span class=o>,</span><span class=n>map</span><span class=p>(</span><span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>haproxy</span><span class=o>/</span><span class=n>redirect</span><span class=o>.</span><span class=n>map</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=n>i</span><span class=w> </span><span class=o>-</span><span class=n>m</span><span class=w> </span><span class=n>found</span><span class=w> </span><span class=o>}</span><span class=w> </span><span class=n>acl</span>
</code></pre></div> </details> <p>Et le contenu du fichier redirect.map</p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a>$<span class=w> </span>cat<span class=w> </span>redirect.map
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>uri1.html<span class=w> </span>https://monsite.fr/coucou
</code></pre></div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Dernière mise à jour"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="22 février 2026 00:43:00 UTC">22 février 2026</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Créé> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="6 juin 2022 18:32:45 UTC">6 juin 2022</span> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Retour en haut de la page </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> </div> <div class=md-social> <a href="https://twitter.com/Pixel__Art" target="_blank" rel="noopener" title="twitter.com" class="md-social__link"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M459.4 151.7c.3 4.5.3 9.1.3 13.6 0 138.7-105.6 298.6-298.6 298.6-59.5 0-114.7-17.2-161.1-47.1 8.4 1 16.6 1.3 25.3 1.3 49.1 0 94.2-16.6 130.3-44.8-46.1-1-84.8-31.2-98.1-72.8 6.5 1 13 1.6 19.8 1.6 9.4 0 18.8-1.3 27.6-3.6-48.1-9.7-84.1-52-84.1-103v-1.3c14 7.8 30.2 12.7 47.4 13.3-28.3-18.8-46.8-51-46.8-87.4 0-19.5 5.2-37.4 14.3-53C87.4 130.8 165 172.4 252.1 176.9c-1.6-7.8-2.6-15.9-2.6-24C249.5 95.1 296.3 48 354.4 48c30.2 0 57.5 12.7 76.7 33.1 23.7-4.5 46.5-13.3 66.6-25.3-7.8 24.4-24.4 44.8-46.1 57.8 21.1-2.3 41.6-8.1 60.4-16.2-14.3 20.8-32.2 39.3-52.6 54.3"/></svg> </a> <a href="https://github.com/PixiBixi" target="_blank" rel="noopener" title="github.com" class="md-social__link"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href="https://fr.linkedin.com/in/je-delgado" target="_blank" rel="noopener" title="fr.linkedin.com" class="md-social__link"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["toc.integrate", "header.autohide", "navigation.tracking", "navigation.instant", "navigation.tabs", "navigation.sections", "navigation.prune", "navigation.top", "content.code.copy", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}, "version": null}</script> <script src=../../../assets/javascripts/bundle.92b07e13.min.js></script> <script id=init-glightbox>document.querySelectorAll('.glightbox').forEach(function(element) {
    try {
        var img = element.querySelector('img');
        if (img && img.src) {
            element.setAttribute('href', img.src);
        } else {
            console.log('No img element with src attribute found');
        }
    } catch (error) {
        console.log('Error:', error);
    }
});
const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>